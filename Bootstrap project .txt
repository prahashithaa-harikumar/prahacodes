import React, { useState } from "react";
import { FormControl, FormLabel, Select, Input, Spinner, VStack, Button } from "@chakra-ui/react";
import axios from "axios";

const CreditForm = () => {
  const [isLoading, setIsLoading] = useState(false);
  const [selectedProductId, setSelectedProductId] = useState("");
  
  // State for form data (saving product type and other fetched data)
  const [formData, setFormData] = useState({
    product: "", // Added product field
    usage: "",
    affiliation: "",
    card_type: "",
    card_limit: "",
    transfer_amount: "",
    valid_upto: "",
    balance_transfer: "",
    effective_rate: "",
  });

  // Handle product selection
  const handleProductChange = async (e) => {
    const selectedProductId = e.target.value; // Capture the selected product ID
    setSelectedProductId(selectedProductId); // Update state with the selected product ID

    setIsLoading(true); // Show spinner while loading

    try {
      // Send selected product ID to the backend and fetch product details
      const response = await axios.get(`http://localhost:8080/api/project/product/${selectedProductId}`);
      
      // Update form data with the response and include the product type
      setFormData({
        product: selectedProductId, // Save the selected product type
        usage: response.data.usage,
        affiliation: response.data.affiliation,
        card_type: response.data.card_type,
        card_limit: response.data.card_limit,
        transfer_amount: response.data.transfer_amount,
        valid_upto: response.data.valid_upto,
        balance_transfer: response.data.balance_transfer,
        effective_rate: response.data.effective_rate,
      });
    } catch (error) {
      console.error("Error fetching product details", error);
    } finally {
      setIsLoading(false); // Hide spinner when done
    }
  };

  return (
    <VStack spacing={4}>
      {/* Dropdown to select product */}
      <FormControl id="product">
        <FormLabel>Product</FormLabel>
        <Select placeholder="Select product" onChange={handleProductChange}>
          <option value="silver">Silver</option>
          <option value="gold">Gold</option>
          <option value="platinum">Platinum</option>
        </Select>
      </FormControl>

      {/* Show Spinner while loading */}
      {isLoading ? (
        <Spinner />
      ) : (
        <>
          {/* Product Type Field */}
          <FormControl id="product-type">
            <FormLabel>Product Type</FormLabel>
            <Input value={formData.product || ""} readOnly />
          </FormControl>

          {/* Usage Field */}
          <FormControl id="usage">
            <FormLabel>Usage</FormLabel>
            <Input value={formData.usage || ""} readOnly />
          </FormControl>

          {/* Affiliation Field */}
          <FormControl id="affiliation">
            <FormLabel>Affiliation</FormLabel>
            <Input value={formData.affiliation || ""} readOnly />
          </FormControl>

          {/* Card Type Field */}
          <FormControl id="card_type">
            <FormLabel>Card Type</FormLabel>
            <Input value={formData.card_type || ""} readOnly />
          </FormControl>

          {/* Card Limit Field */}
          <FormControl id="card_limit">
            <FormLabel>Card Limit</FormLabel>
            <Input value={formData.card_limit || ""} readOnly />
          </FormControl>

          {/* Transfer Amount Field */}
          <FormControl id="transfer_amount">
            <FormLabel>Transfer Amount</FormLabel>
            <Input value={formData.transfer_amount || ""} readOnly />
          </FormControl>

          {/* Valid Upto Field */}
          <FormControl id="valid_upto">
            <FormLabel>Valid Upto</FormLabel>
            <Input value={formData.valid_upto || ""} readOnly />
          </FormControl>

          {/* Balance Transfer Field */}
          <FormControl id="balance_transfer">
            <FormLabel>Balance Transfer</FormLabel>
            <Input value={formData.balance_transfer || ""} readOnly />
          </FormControl>

          {/* Effective Rate Field */}
          <FormControl id="effective_rate">
            <FormLabel>Effective Rate</FormLabel>
            <Input value={formData.effective_rate || ""} readOnly />
          </FormControl>
        </>
      )}
    </VStack>
  );
};

export default CreditForm;